<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>心智圖儀表板</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { 
            width: 300px; 
            background-color: #f8f9fa; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            border-right: 1px solid #ddd; 
            flex-shrink: 0;
            transition: width 0.3s ease, padding 0.3s ease; /* 加上 padding 的動畫 */
        }
        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid #ddd; }
        .sidebar-header h2 { margin: 0; font-size: 1.25rem; color: #333; }
        #search-box { width: 100%; padding: 10px; margin-top: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        #map-list { list-style: none; padding: 0; margin: 0; }
        .category-header { padding: 12px 0; font-weight: bold; color: #0056b3; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .category-header::after { content: '▼'; font-size: 0.8em; transition: transform 0.2s; }
        .category-header.open::after { transform: rotate(-180deg); }
        .map-items-container { list-style: none; padding-left: 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .map-items-container.open { max-height: 1000px; }
        .map-item a { display: block; padding: 10px 15px; text-decoration: none; color: #333; border-radius: 5px; margin: 4px 0; transition: background-color 0.2s, color 0.2s; }
        .map-item a:hover { background-color: #e9ecef; }
        
        .map-item a.active {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
            box-shadow: inset 3px 0 0 #3498db;
        }

        .sidebar-footer { padding: 15px 20px; text-align: center; font-size: 0.85em; color: #6c757d; border-top: 1px solid #ddd; background-color: #f8f9fa; margin-top: auto; }
        #content-area { flex-grow: 1; display: flex; }
        #mindmap-frame { width: 100%; height: 100%; border: none; }
        
        #sidebar-toggle-btn {
            position: absolute;
            left: 300px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 40px;
            background-color: #2c3e50;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.3s ease;
            color: white;
            font-size: 16px;
            font-weight: bold;
            line-height: 40px;
        }
        #sidebar-toggle-btn:hover {
            background-color: #34495e;
        }

        body.sidebar-collapsed #sidebar {
            width: 0;
            overflow: hidden;
            padding-left: 0;
            padding-right: 0;
            border-right: none;
        }
        body.sidebar-collapsed #sidebar-toggle-btn {
            left: 0;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <h2>心智圖主題</h2>
            <input type="text" id="search-box" placeholder="搜尋主題...">
        </div>
        <div class="sidebar-content">
            <ul id="map-list"></ul>
        </div>
        <div class="sidebar-footer">過勞律師製作</div>
    </div>

    <div id="sidebar-toggle-btn">&lt;</div>

    <div id="content-area">
        <iframe id="mindmap-frame" src="welcome.html" title="Mindmap Display"></iframe>
    </div>

    <script>
        const mindmapData = [
            {
                category: '法規與條款',
                maps: [
                    { id: 'life-insurance-enforcement-review', title: '人壽保單強制執行審查表', file: 'maps/251028保單強制執行免除及權益主張審查表.html' },
                    { id: 'labor-law-summary', title: '勞基法重點整理', file: 'maps/labor-law.html' }
                ]
            },
            {
                category: '專案管理',
                maps: [
                    { id: 'project-kickoff', title: '專案啟動會議流程', file: 'maps/project-kickoff.html' },
                    { id: 'risk-matrix', title: '風險管理矩陣', file: 'maps/risk-matrix.html' }
                ]
            },
            {
                category: '未分類',
                maps: [
                    { id: 'example-map-2', title: '範例：第二個心智圖', file: 'maps/another-mindmap.html' }
                ]
            }
        ];
        document.addEventListener('DOMContentLoaded', function() {
            const mapList = document.getElementById('map-list');
            const mindmapFrame = document.getElementById('mindmap-frame');
            const searchBox = document.getElementById('search-box');
            let currentActiveLink = null;
            
            mindmapFrame.addEventListener('load', function() { try { const iframeDoc = mindmapFrame.contentWindow.document; iframeDoc.documentElement.classList.add('markmap-dark'); } catch (e) { console.error("無法修改 iframe 內容:", e); } });

            function loadMapById(mapId) {
                const allMaps = mindmapData.flatMap(category => category.maps);
                const mapToLoad = allMaps.find(m => m.id === mapId);
                if (!mapToLoad) { console.warn(`找不到 ID 為 "${mapId}" 的心智圖`); return; }
                mindmapFrame.src = mapToLoad.file;
                if (currentActiveLink) { currentActiveLink.classList.remove('active'); }
                const newActiveLink = document.querySelector(`a[data-map-id="${mapId}"]`);
                if (newActiveLink) {
                    newActiveLink.classList.add('active');
                    currentActiveLink = newActiveLink;
                    const parentContainer = newActiveLink.closest('.map-items-container');
                    if (parentContainer && !parentContainer.classList.contains('open')) {
                        parentContainer.classList.add('open');
                        parentContainer.previousElementSibling.classList.add('open');
                    }
                }
                if (window.location.hash !== '#' + mapId) { window.location.hash = mapId; }
            }

            function generateMenu(data) {
                mapList.innerHTML = '';
                data.forEach(categoryData => {
                    const categoryLi = document.createElement('li');
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header';
                    categoryHeader.textContent = categoryData.category;
                    categoryLi.appendChild(categoryHeader);
                    
                    const itemsContainer = document.createElement('ul');
                    itemsContainer.className = 'map-items-container';
                    categoryData.maps.forEach(map => {
                        const mapItemLi = document.createElement('li');
                        mapItemLi.className = 'map-item';
                        const link = document.createElement('a');
                        link.href = '#' + map.id;
                        link.textContent = map.title;
                        link.dataset.mapId = map.id;
                        link.addEventListener('click', function(e) { e.preventDefault(); loadMapById(this.dataset.mapId); });
                        mapItemLi.appendChild(link);
                        itemsContainer.appendChild(mapItemLi);
                    });
                    
                    categoryLi.appendChild(itemsContainer);
                    mapList.appendChild(categoryLi);
                    
                    // --- 這裡是修正的重點 ---
                    // 將 addEventListener 從 appendChild 中分離出來，單獨執行
                    categoryHeader.addEventListener('click', () => {
                        categoryHeader.classList.toggle('open');
                        itemsContainer.classList.toggle('open');
                    });
                });
            }
            
            function filterMaps() {
                const searchTerm = searchBox.value.toLowerCase();
                const filteredData = mindmapData.map(category => {
                    const filteredMaps = category.maps.filter(map => map.title.toLowerCase().includes(searchTerm));
                    return { ...category, maps: filteredMaps };
                }).filter(category => category.maps.length > 0);
                generateMenu(filteredData);
            }

            generateMenu(mindmapData);
            searchBox.addEventListener('input', filterMaps);

            function handleUrlChange() { const mapId = window.location.hash.substring(1); if (mapId) { loadMapById(mapId); } }
            window.addEventListener('hashchange', handleUrlChange);
            handleUrlChange();

            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            toggleBtn.addEventListener('click', function() {
                const isCollapsed = document.body.classList.toggle('sidebar-collapsed');
                toggleBtn.innerHTML = isCollapsed ? '&gt;' : '&lt;';
            });
        });
    </script>
</body>
</html>